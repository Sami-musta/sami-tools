<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Converter | CSV ⟷ Excel ⟷ JSON</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            overflow-x: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: #ffffff;
            color: #000000;
            line-height: 1.6;
            overflow-x: hidden;
            padding-top: 70px; /* Space for fixed header */
        }

        /* Navigation Header */
        .top-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #000000;
            color: #ffffff;
            z-index: 1000;
            border-bottom: 3px solid #ff6b35;
        }

        .nav-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-logo {
            font-size: 1.2rem;
            font-weight: 800;
            letter-spacing: -0.5px;
            text-transform: uppercase;
            text-decoration: none;
            color: #ffffff;
        }

        .nav-logo:hover {
            color: #ff6b35;
        }

        .nav-links {
            display: flex;
            gap: 25px;
            align-items: center;
        }

        .nav-link {
            color: #ffffff;
            text-decoration: none;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.85rem;
            transition: color 0.3s ease;
            padding: 8px 12px;
            border-radius: 4px;
        }

        .nav-link:hover {
            color: #ff6b35;
            background: rgba(255, 107, 53, 0.1);
        }

        .nav-back-btn {
            background: #ff6b35;
            color: #ffffff;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .nav-back-btn:hover {
            background: #e55a2b;
            transform: translateY(-1px);
        }

        .header {
            background: #000000;
            color: #ffffff;
            padding: 20px 0;
            border-bottom: 3px solid #ff6b35;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 800;
            letter-spacing: -0.5px;
            text-transform: uppercase;
        }

        .subtitle-header {
            font-size: 0.9rem;
            opacity: 0.7;
            font-weight: 400;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .hero-section {
            text-align: center;
            margin-bottom: 60px;
            padding: 40px 0;
        }

        .hero-title {
            font-size: 3rem;
            font-weight: 900;
            color: #000000;
            margin-bottom: 16px;
            letter-spacing: -1px;
        }

        .hero-description {
            font-size: 1.2rem;
            color: #666666;
            max-width: 600px;
            margin: 0 auto 40px;
            line-height: 1.5;
        }

        .feature-pills {
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .pill {
            background: #f5f5f5;
            color: #333;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            border: 1px solid #e0e0e0;
        }

        .section {
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .section-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #000000;
            margin-bottom: 20px;
            border-bottom: 2px solid #ff6b35;
            padding-bottom: 8px;
            display: inline-block;
        }

        .upload-zone {
            border: 2px dashed #cccccc;
            border-radius: 8px;
            padding: 60px 20px;
            text-align: center;
            background: #fafafa;
            transition: all 0.3s ease;
            cursor: pointer;
            margin: 20px 0;
        }

        .upload-zone:hover,
        .upload-zone.dragover {
            border-color: #ff6b35;
            background: #fff9f7;
        }

        .upload-icon {
            font-size: 2.5rem;
            color: #999999;
            margin-bottom: 16px;
            display: block;
        }

        .upload-zone:hover .upload-icon,
        .upload-zone.dragover .upload-icon {
            color: #ff6b35;
        }

        .upload-text {
            color: #333333;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .upload-subtext {
            color: #666666;
            font-size: 0.9rem;
        }

        input[type="file"] {
            display: none;
        }

        .btn {
            background: #000000;
            color: #ffffff;
            border: none;
            padding: 14px 28px;
            border-radius: 4px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn:hover {
            background: #333333;
            transform: translateY(-1px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #ffffff;
            color: #000000;
            border: 2px solid #000000;
        }

        .btn-secondary:hover {
            background: #000000;
            color: #ffffff;
        }

        .btn-accent {
            background: #ff6b35;
            color: #ffffff;
        }

        .btn-accent:hover {
            background: #e55a2b;
        }

        .file-info {
            background: #f8f9fa;
            border-left: 4px solid #ff6b35;
            padding: 20px;
            margin: 20px 0;
            display: none;
            border-radius: 0 4px 4px 0;
        }

        .file-name {
            font-weight: 600;
            color: #000000;
            margin-bottom: 5px;
        }

        .file-size {
            color: #666666;
            font-size: 0.9rem;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .option-group {
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
        }

        .option-title {
            font-weight: 700;
            color: #000000;
            margin-bottom: 16px;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            padding: 12px;
            border-radius: 4px;
            transition: all 0.2s ease;
            border: 1px solid #e0e0e0;
        }

        .radio-option:hover {
            background: #f8f9fa;
            border-color: #ff6b35;
        }

        .radio-option input[type="radio"] {
            width: 18px;
            height: 18px;
            accent-color: #ff6b35;
        }

        .radio-option input[type="radio"]:checked + span {
            font-weight: 600;
            color: #ff6b35;
        }

        .controls {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .preview-section {
            display: none;
            margin: 40px 0;
        }

        .preview-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }

        .preview-panel {
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            min-width: 0;
        }

        .preview-header {
            background: #f8f9fa;
            padding: 16px 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .preview-title {
            font-weight: 700;
            color: #000000;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .preview-title.original {
            color: #dc3545;
        }

        .preview-title.converted {
            color: #28a745;
        }

        .preview-info {
            font-size: 0.85rem;
            color: #666666;
        }

        .preview-content {
            padding: 20px;
            max-height: 400px;
            overflow: auto;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            background: #ffffff;
        }

        .preview-table th {
            background: #000000;
            color: #ffffff;
            padding: 12px 8px;
            font-weight: 600;
            text-align: left;
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .preview-table td {
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: #333333;
        }

        .preview-table tr:nth-child(even) {
            background: #fafafa;
        }

        .preview-table tr:hover {
            background: #f5f5f5;
        }

        .json-preview {
            background: #1a1a1a;
            color: #f8f8f2;
            border-radius: 4px;
            padding: 16px;
            font-family: 'SF Mono', Monaco, Inconsolata, 'Roboto Mono', 'Consolas', 'Courier New', monospace;
            font-size: 0.8rem;
            line-height: 1.4;
            max-height: 400px;
            overflow: auto;
            white-space: pre-wrap;
            word-break: break-all;
            overflow-wrap: break-word;
        }

        .json-key {
            color: #66d9ef;
        }

        .json-string {
            color: #a6e22e;
        }

        .json-number {
            color: #ae81ff;
        }

        .json-boolean {
            color: #fd971f;
        }

        .json-null {
            color: #f92672;
        }

        .status {
            padding: 16px 20px;
            border-radius: 4px;
            margin: 20px 0;
            display: none;
            font-weight: 500;
            border-left: 4px solid;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border-left-color: #28a745;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border-left-color: #dc3545;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666666;
            font-weight: 500;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #ff6b35;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 12px;
            vertical-align: middle;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .footer {
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            padding: 30px 0;
            text-align: center;
            margin-top: 60px;
        }

        .footer-content {
            color: #666666;
            font-size: 0.9rem;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .preview-grid {
                gap: 20px;
            }
        }

        @media (max-width: 1024px) {
            .preview-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .container {
                padding: 30px 20px;
            }

            .json-preview {
                font-size: 0.75rem;
                padding: 12px;
            }

            .preview-table {
                font-size: 0.8rem;
            }

            .options-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            body {
                padding-top: 60px;
            }

            .nav-content {
                padding: 12px 16px;
                flex-wrap: wrap;
                gap: 10px;
            }

            .nav-links {
                gap: 15px;
            }

            .nav-link {
                font-size: 0.8rem;
                padding: 6px 10px;
            }

            .nav-back-btn {
                font-size: 0.8rem;
                padding: 6px 12px;
            }

            .container {
                padding: 20px 16px;
            }
            
            .hero-title {
                font-size: 2.2rem;
            }

            .hero-description {
                font-size: 1.1rem;
            }

            .header-content {
                flex-direction: column;
                gap: 8px;
                text-align: center;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
                gap: 12px;
            }

            .btn {
                width: 100%;
                max-width: 300px;
                justify-content: center;
            }

            .upload-zone {
                padding: 40px 15px;
                margin: 15px 0;
            }

            .upload-icon {
                font-size: 2rem;
            }

            .section {
                padding: 20px;
            }

            .preview-content {
                padding: 15px;
                max-height: 300px;
            }

            .json-preview {
                font-size: 0.7rem;
                padding: 10px;
                max-height: 250px;
                line-height: 1.3;
            }

            .preview-table {
                font-size: 0.75rem;
            }

            .preview-table th,
            .preview-table td {
                padding: 6px 4px;
                max-width: 80px;
            }

            .feature-pills {
                gap: 8px;
            }

            .pill {
                font-size: 0.8rem;
                padding: 6px 12px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px 12px;
            }

            .hero-title {
                font-size: 1.8rem;
                margin-bottom: 12px;
            }

            .hero-description {
                font-size: 1rem;
                margin-bottom: 30px;
            }

            .section {
                padding: 16px;
                margin-bottom: 20px;
            }

            .upload-zone {
                padding: 30px 12px;
            }

            .upload-text {
                font-size: 1rem;
            }

            .upload-subtext {
                font-size: 0.85rem;
            }

            .btn {
                padding: 12px 20px;
                font-size: 0.9rem;
            }

            .option-group {
                padding: 16px;
            }

            .radio-option {
                padding: 10px;
                font-size: 0.9rem;
            }

            .preview-header {
                padding: 12px 16px;
            }

            .preview-content {
                padding: 12px;
                max-height: 250px;
            }

            .json-preview {
                font-size: 0.65rem;
                padding: 8px;
                max-height: 200px;
            }

            .preview-table th,
            .preview-table td {
                padding: 4px 3px;
                max-width: 60px;
                font-size: 0.7rem;
            }

            .status {
                padding: 12px 16px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <!-- Top Navigation -->
    <nav class="top-nav">
        <div class="nav-content">
            <a href="../../index.html" class="nav-logo">Sami's Tools</a>
            <div class="nav-links">
                <a href="../../index.html" class="nav-link">Home</a>
                <a href="../../index.html#tools" class="nav-link">Tools</a>
                <a href="https://github.com/Sami-musta" class="nav-link" target="_blank">GitHub</a>
                <a href="../../index.html" class="nav-back-btn">← Back to Hub</a>
            </div>
        </div>
    </nav>

    <header class="header">
        <div class="header-content">
            <div>
                <div class="logo">File Converter</div>
                <div class="subtitle-header">Professional File Conversion Tool</div>
            </div>
        </div>
    </header>

    <div class="container">
        <section class="hero-section">
            <h1 class="hero-title">Convert Files Instantly</h1>
            <p class="hero-description">
                Transform your data between CSV, Excel, and JSON formats with real-time preview and advanced options. No registration required.
            </p>
            <div class="feature-pills">
                <span class="pill">CSV ⟷ Excel</span>
                <span class="pill">JSON Export</span>
                <span class="pill">Live Preview</span>
                <span class="pill">100% Local</span>
                <span class="pill">No Upload</span>
            </div>
        </section>

        <section class="section">
            <h2 class="section-title">Upload File</h2>
            
            <div class="upload-zone" id="uploadZone">
                <span class="upload-icon">📁</span>
                <div class="upload-text">Drop your file here or click to browse</div>
                <div class="upload-subtext">Supports CSV, XLS, XLSX files up to 50MB</div>
                <input type="file" id="fileInput" accept=".csv,.xls,.xlsx">
            </div>

            <div class="file-info" id="fileInfo">
                <div class="file-name" id="fileName"></div>
                <div class="file-size" id="fileSize"></div>
            </div>
        </section>

        <section class="section" id="optionsSection" style="display: none;">
            <h2 class="section-title">Conversion Options</h2>
            
            <div class="options-grid">
                <div class="option-group">
                    <div class="option-title">Output Format</div>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="outputFormat" value="xlsx">
                            <span>📊 Excel (.xlsx)</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="outputFormat" value="csv">
                            <span>📄 CSV</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="outputFormat" value="json">
                            <span>🔗 JSON</span>
                        </label>
                    </div>
                </div>

                <div class="option-group" id="csvOptions" style="display: none;">
                    <div class="option-title">CSV Settings</div>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="csvSeparator" value="," checked>
                            <span>Comma (,)</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="csvSeparator" value=";">
                            <span>Semicolon (;)</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="csvSeparator" value="\t">
                            <span>Tab</span>
                        </label>
                    </div>
                </div>

                <div class="option-group" id="jsonOptions" style="display: none;">
                    <div class="option-title">JSON Structure</div>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="jsonFormat" value="array" checked>
                            <span>🔢 Array of Objects</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="jsonFormat" value="rows">
                            <span>📋 Headers + Rows</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="jsonFormat" value="simple">
                            <span>📝 Simple Array</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="controls">
                <button class="btn btn-secondary" id="previewBtn">👁️ Preview</button>
                <button class="btn btn-accent" id="convertBtn">⚡ Convert & Download</button>
            </div>
        </section>

        <section class="preview-section" id="previewSection">
            <div class="section">
                <h2 class="section-title">File Preview</h2>
                
                <div class="preview-grid">
                    <div class="preview-panel">
                        <div class="preview-header">
                            <h3 class="preview-title original">📄 Original File</h3>
                            <div class="preview-info" id="originalInfo"></div>
                        </div>
                        <div class="preview-content">
                            <table class="preview-table" id="originalTable"></table>
                        </div>
                    </div>
                    
                    <div class="preview-panel">
                        <div class="preview-header">
                            <h3 class="preview-title converted">🔄 Converted Preview</h3>
                            <div class="preview-info" id="convertedInfo"></div>
                        </div>
                        <div class="preview-content" id="convertedContent">
                            <table class="preview-table" id="convertedTable"></table>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <div class="loading" id="loading">
            <span class="spinner"></span>
            Processing your file...
        </div>

        <div class="status" id="status"></div>
    </div>

    <footer class="footer">
        <div class="footer-content">
            <p>Built with modern web technologies • All processing happens locally in your browser • No data is sent to servers</p>
        </div>
    </footer>

    <script>
        let currentFile = null;
        let originalData = null;
        let convertedData = null;

        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const optionsSection = document.getElementById('optionsSection');
        const previewBtn = document.getElementById('previewBtn');
        const convertBtn = document.getElementById('convertBtn');
        const loading = document.getElementById('loading');
        const status = document.getElementById('status');
        const csvOptions = document.getElementById('csvOptions');
        const jsonOptions = document.getElementById('jsonOptions');
        const previewSection = document.getElementById('previewSection');

        // Event Listeners
        uploadZone.addEventListener('click', () => fileInput.click());
        uploadZone.addEventListener('dragover', handleDragOver);
        uploadZone.addEventListener('dragleave', handleDragLeave);
        uploadZone.addEventListener('drop', handleDrop);
        fileInput.addEventListener('change', handleFileSelect);

        document.querySelectorAll('input[name="outputFormat"]').forEach(radio => {
            radio.addEventListener('change', handleFormatChange);
        });

        document.querySelectorAll('input[name="csvSeparator"]').forEach(radio => {
            radio.addEventListener('change', updatePreviewIfVisible);
        });

        document.querySelectorAll('input[name="jsonFormat"]').forEach(radio => {
            radio.addEventListener('change', updatePreviewIfVisible);
        });

        previewBtn.addEventListener('click', showPreview);
        convertBtn.addEventListener('click', convertFile);

        function handleDragOver(e) {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            const validTypes = ['.csv', '.xls', '.xlsx'];
            const fileExt = '.' + file.name.split('.').pop().toLowerCase();
            
            if (!validTypes.includes(fileExt)) {
                showStatus('Unsupported file format. Please use CSV, XLS, or XLSX files.', 'error');
                return;
            }

            currentFile = file;
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileInfo.style.display = 'block';
            
            // Set default output format
            const inputFormat = fileExt.substring(1);
            let outputFormat;
            if (inputFormat === 'csv') {
                outputFormat = 'xlsx';
            } else {
                outputFormat = 'csv';
            }
            document.querySelector(`input[name="outputFormat"][value="${outputFormat}"]`).checked = true;
            
            handleFormatChange();
            optionsSection.style.display = 'block';
            previewSection.style.display = 'none';
            originalData = null;
            convertedData = null;
            hideStatus();
        }

        function handleFormatChange() {
            const selectedFormat = document.querySelector('input[name="outputFormat"]:checked').value;
            csvOptions.style.display = selectedFormat === 'csv' ? 'block' : 'none';
            jsonOptions.style.display = selectedFormat === 'json' ? 'block' : 'none';
            updatePreviewIfVisible();
        }

        function updatePreviewIfVisible() {
            if (previewSection.style.display !== 'none' && originalData) {
                try {
                    generateConvertedPreview();
                    displayConvertedPreview();
                } catch (error) {
                    console.error('Error updating preview:', error);
                    showStatus('Error updating preview.', 'error');
                }
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function showPreview() {
            if (!currentFile) return;

            showLoading();
            hideStatus();

            try {
                await parseOriginalFile();
                generateConvertedPreview();
                displayOriginalPreview();
                displayConvertedPreview();
                previewSection.style.display = 'block';
                
            } catch (error) {
                console.error('Preview generation error:', error);
                showStatus('Error generating preview. Please check your file format.', 'error');
            } finally {
                hideLoading();
            }
        }

        async function parseOriginalFile() {
            const arrayBuffer = await readFileAsArrayBuffer(currentFile);
            const inputFormat = currentFile.name.split('.').pop().toLowerCase();

            if (inputFormat === 'csv') {
                const text = new TextDecoder('utf-8').decode(arrayBuffer);
                const delimiter = detectDelimiter(text);
                const parsed = Papa.parse(text, {
                    header: false,
                    skipEmptyLines: true,
                    delimiter: delimiter
                });
                originalData = {
                    data: parsed.data,
                    format: 'csv',
                    delimiter: delimiter,
                    info: `Format: CSV • Delimiter: ${getDelimiterName(delimiter)} • ${parsed.data.length} rows`
                };
            } else {
                const workbook = XLSX.read(arrayBuffer, {type: 'array'});
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const data = XLSX.utils.sheet_to_json(worksheet, {header: 1, defval: ''});
                
                originalData = {
                    data: data,
                    format: inputFormat,
                    sheetName: sheetName,
                    info: `Format: ${inputFormat.toUpperCase()} • Sheet: ${sheetName} • ${data.length} rows`
                };
            }
        }

        function generateConvertedPreview() {
            if (!originalData) {
                console.error('Original data not available');
                return;
            }

            const outputFormat = document.querySelector('input[name="outputFormat"]:checked').value;
            
            try {
                if (outputFormat === 'csv') {
                    const separator = document.querySelector('input[name="csvSeparator"]:checked').value;
                    convertedData = {
                        data: originalData.data,
                        format: 'csv',
                        delimiter: separator,
                        info: `Format: CSV • Delimiter: ${getDelimiterName(separator)} • ${originalData.data.length} rows`
                    };
                } else if (outputFormat === 'json') {
                    const jsonFormat = document.querySelector('input[name="jsonFormat"]:checked').value;
                    const jsonData = convertToJson(originalData.data, jsonFormat);
                    convertedData = {
                        data: jsonData,
                        format: 'json',
                        jsonFormat: jsonFormat,
                        info: `Format: JSON • Structure: ${getJsonFormatName(jsonFormat)} • ${originalData.data.length} rows`
                    };
                } else {
                    convertedData = {
                        data: originalData.data,
                        format: 'xlsx',
                        sheetName: 'Sheet1',
                        info: `Format: XLSX • Sheet: Sheet1 • ${originalData.data.length} rows`
                    };
                }
            } catch (error) {
                console.error('Error generating converted preview:', error);
                convertedData = {
                    data: [],
                    format: outputFormat,
                    info: 'Conversion error'
                };
            }
        }

        function displayOriginalPreview() {
            const table = document.getElementById('originalTable');
            const info = document.getElementById('originalInfo');
            
            if (!table || !info) {
                console.error('Original preview elements not found');
                return;
            }
            
            info.textContent = originalData.info;
            createTableFromData(table, originalData.data, 'original');
        }

        function displayConvertedPreview() {
            const info = document.getElementById('convertedInfo');
            info.textContent = convertedData.info;
            
            const previewContent = document.getElementById('convertedContent');
            
            if (!previewContent) {
                console.error('Converted preview container not found');
                return;
            }
            
            if (convertedData.format === 'json') {
                createJsonPreview(previewContent);
            } else {
                resetTableContainer(previewContent);
                const table = document.getElementById('convertedTable');
                createTableFromData(table, convertedData.data, 'converted');
            }
        }

        function resetTableContainer(container) {
            container.innerHTML = '<table class="preview-table" id="convertedTable"></table>';
        }

        function convertToJson(data, format) {
            if (!data || data.length === 0) {
                console.warn('Empty data for JSON conversion');
                return [];
            }

            try {
                switch (format) {
                    case 'array':
                        if (data.length < 2) return [];
                        const headers = data[0];
                        return data.slice(1).map(row => {
                            const obj = {};
                            headers.forEach((header, index) => {
                                const key = header || `col_${index + 1}`;
                                obj[key] = row[index] !== undefined ? row[index] : null;
                            });
                            return obj;
                        });
                    
                    case 'rows':
                        return {
                            headers: data[0] || [],
                            rows: data.slice(1)
                        };
                    
                    case 'simple':
                        return data;
                    
                    default:
                        console.warn(`Unrecognized JSON format: ${format}`);
                        return data;
                }
            } catch (error) {
                console.error('Error in JSON conversion:', error);
                return data;
            }
        }

        function getJsonFormatName(format) {
            switch(format) {
                case 'array': return 'Array of Objects';
                case 'rows': return 'Headers + Rows';
                case 'simple': return 'Simple Array';
                default: return format;
            }
        }

        function createJsonPreview(container) {
            container.innerHTML = '<div class="json-preview" id="jsonPreview"></div>';
            
            const jsonPreview = document.getElementById('jsonPreview');
            
            if (!jsonPreview) {
                console.error('Cannot create JSON preview');
                return;
            }
            
            let previewData = convertedData.data;
            if (Array.isArray(convertedData.data) && convertedData.data.length > 10) {
                previewData = convertedData.data.slice(0, 10);
            }
            
            try {
                const formattedJson = JSON.stringify(previewData, null, 2);
                const coloredJson = formatJsonWithColors(formattedJson);
                
                jsonPreview.innerHTML = coloredJson;
                
                if (Array.isArray(convertedData.data) && convertedData.data.length > 10) {
                    jsonPreview.innerHTML += `\n\n<span style="color: #75715e; font-style: italic;">... (${convertedData.data.length - 10} more items hidden in preview)</span>`;
                }
            } catch (error) {
                console.error('Error formatting JSON:', error);
                jsonPreview.innerHTML = '<span style="color: #f92672;">Error generating JSON preview</span>';
            }
        }

        function formatJsonWithColors(jsonString) {
            return jsonString
                .replace(/"([^"]+)":/g, '<span class="json-key">"$1"</span>:')
                .replace(/: "([^"]*)"/g, ': <span class="json-string">"$1"</span>')
                .replace(/: (\d+\.?\d*)/g, ': <span class="json-number">$1</span>')
                .replace(/: (true|false)/g, ': <span class="json-boolean">$1</span>')
                .replace(/: null/g, ': <span class="json-null">null</span>');
        }

        function createTableFromData(table, data, type) {
            table.innerHTML = '';
            
            if (!data || data.length === 0) {
                table.innerHTML = '<tr><td>No data to display</td></tr>';
                return;
            }

            const maxRows = 20;
            const maxCols = 10;
            const displayData = data.slice(0, maxRows).map(row => 
                Array.isArray(row) ? row.slice(0, maxCols) : Object.values(row).slice(0, maxCols)
            );

            if (displayData.length > 0) {
                const headerRow = document.createElement('tr');
                const firstRow = displayData[0];
                
                for (let i = 0; i < firstRow.length; i++) {
                    const th = document.createElement('th');
                    th.textContent = `Col ${i + 1}`;
                    headerRow.appendChild(th);
                }
                table.appendChild(headerRow);
            }

            displayData.forEach(row => {
                const tr = document.createElement('tr');
                row.forEach(cell => {
                    const td = document.createElement('td');
                    td.textContent = cell !== null && cell !== undefined ? String(cell) : '';
                    td.title = td.textContent;
                    tr.appendChild(td);
                });
                table.appendChild(tr);
            });

            if (data.length > maxRows || (data[0] && data[0].length > maxCols)) {
                const noteRow = document.createElement('tr');
                const noteCell = document.createElement('td');
                noteCell.colSpan = displayData[0] ? displayData[0].length : 1;
                noteCell.textContent = `... Preview limited (${Math.min(maxRows, data.length)}/${data.length} rows shown)`;
                noteCell.style.fontStyle = 'italic';
                noteCell.style.textAlign = 'center';
                noteCell.style.backgroundColor = '#f8f9fa';
                noteCell.style.color = '#666666';
                noteRow.appendChild(noteCell);
                table.appendChild(noteRow);
            }
        }

        async function convertFile() {
            if (!currentFile) return;

            showLoading();
            hideStatus();

            try {
                if (!originalData) {
                    await parseOriginalFile();
                }

                const outputFormat = document.querySelector('input[name="outputFormat"]:checked').value;
                let outputBlob;
                let outputFileName;

                if (outputFormat === 'xlsx') {
                    const workbook = XLSX.utils.book_new();
                    const worksheet = XLSX.utils.aoa_to_sheet(originalData.data);
                    XLSX.utils.book_append_sheet(workbook, worksheet, "Sheet1");
                    
                    const excelBuffer = XLSX.write(workbook, {bookType: 'xlsx', type: 'array'});
                    outputBlob = new Blob([excelBuffer], {type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
                    outputFileName = currentFile.name.replace(/\.[^/.]+$/, '.xlsx');
                } else if (outputFormat === 'json') {
                    const jsonFormat = document.querySelector('input[name="jsonFormat"]:checked').value;
                    const jsonData = convertToJson(originalData.data, jsonFormat);
                    const jsonString = JSON.stringify(jsonData, null, 2);
                    
                    outputBlob = new Blob([jsonString], {type: 'application/json;charset=utf-8;'});
                    outputFileName = currentFile.name.replace(/\.[^/.]+$/, '.json');
                } else {
                    const separator = document.querySelector('input[name="csvSeparator"]:checked').value;
                    const csvContent = originalData.data.map(row => 
                        row.map(cell => {
                            const cellStr = String(cell || '');
                            if (cellStr.includes(separator) || cellStr.includes('\n') || cellStr.includes('"')) {
                                return '"' + cellStr.replace(/"/g, '""') + '"';
                            }
                            return cellStr;
                        }).join(separator)
                    ).join('\n');
                    
                    outputBlob = new Blob([csvContent], {type: 'text/csv;charset=utf-8;'});
                    outputFileName = currentFile.name.replace(/\.[^/.]+$/, '.csv');
                }

                downloadFile(outputBlob, outputFileName);
                showStatus(`✅ Conversion successful! File "${outputFileName}" has been downloaded.`, 'success');

            } catch (error) {
                console.error('Conversion error:', error);
                showStatus('❌ Conversion failed. Please check your file format.', 'error');
            } finally {
                hideLoading();
            }
        }

        function detectDelimiter(text) {
            const delimiters = [',', ';', '\t'];
            let maxCount = 0;
            let bestDelimiter = ',';

            delimiters.forEach(delimiter => {
                const count = (text.match(new RegExp(delimiter === '\t' ? '\\t' : '\\' + delimiter, 'g')) || []).length;
                if (count > maxCount) {
                    maxCount = count;
                    bestDelimiter = delimiter;
                }
            });

            return bestDelimiter;
        }

        function getDelimiterName(delimiter) {
            switch(delimiter) {
                case ',': return 'Comma (,)';
                case ';': return 'Semicolon (;)';
                case '\t': return 'Tab';
                default: return delimiter;
            }
        }

        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(e);
                reader.readAsArrayBuffer(file);
            });
        }

        function downloadFile(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showLoading() {
            loading.style.display = 'block';
            convertBtn.disabled = true;
            previewBtn.disabled = true;
        }

        function hideLoading() {
            loading.style.display = 'none';
            convertBtn.disabled = false;
            previewBtn.disabled = false;
        }

        function showStatus(message, type) {
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
        }

        function hideStatus() {
            status.style.display = 'none';
        }
    </script>
</body>
</html>
